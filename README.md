# Design of an application that sells content

## Оглавление

- [Design of an application that sells content](#design-of-an-application-that-sells-content)
  - [Оглавление](#оглавление)
  - [Исходные данные](#исходные-данные)
    - [Требования](#требования)
    - [Ограничения](#ограничения)
    - [Допущения](#допущения)
    - [Stakeholders и перечень их интересов](#stakeholders-и-перечень-их-интересов)
    - [User requirements](#user-requirements)
    - [Контекстная схема](#контекстная-схема)
    - [Контейнерная схема](#контейнерная-схема)
    - [Инфраструктурная схема](#инфраструктурная-схема)
    - [Ключевые атрибуты качества](#ключевые-атрибуты-качества)
    - [Риски](#риски)
    - [Безопасность](#безопасность)
      - [Аутентификация и авторизация](#аутентификация-и-авторизация)
      - [Криптография](#криптография)
      - [Self-testing](#self-testing)
      - [Приватные подсети](#приватные-подсети)
      - [Технический аудит](#технический-аудит)
    - [Элементы архитектуры](#элементы-архитектуры)
    - [Компоненты архитектуры в приземлении на AWS и OpenSource](#компоненты-архитектуры-в-приземлении-на-aws-и-opensource)
    - [Architecture Decision Records (ADRs)](#architecture-decision-records-adrs)
    - [Глоссарий](#глоссарий)

## Исходные данные

### Требования

В данном разделе представлены бизнес-требования, которые сформулировал заказчик:

- Необходимо спроектировать архитектуру приложения продающего контент
- Витрина: мобильное приложение
- Оплата App Store, Google Play

### Ограничения

В данном разделе представлены ограничения, которые сформулировал заказчик:

- Количество зарегистрированных пользователей - 100 000
- 100 TPS

### Допущения

Здесь описаны основные допущения, которые были выявлены в ходе исследования:

- Инфраструктура размещена в облаке (Amazon Web Services). На самом деле это не принципиально. Решение может быть развернуто также On Premise с использованием Open Source (перечислены в приложении).
- Предполагаем, что для разработки мы можем задействовать команду разработки (Java - Spring, Javascript - React, Swift, Kotlin)
- Предполагаем, что если у нас нагрузка 100 TPS, то количество запросов на чтение каталога может быть 500 RPS (в пять раз больше)
- Предполагаем, что каталог контента не очень большой (1000 наименований товаров)
- Берем за основу средний размер контента равный 10МБ.
- Предполагаем, что после покупки контент доступен клиенту на определенный период времени. По истечению этого периода контент блокируется.
- Предполагаем, что контент создают сотрудники нашего сервиса

### Stakeholders и перечень их интересов

В данном разделе описаны группы заинтересованных лиц, которые могут оказывать влияние на дизайн решения, а также перечень их интересов, которые необходимо учитывать при проектировании решения

- **Customer** - наш клиент, который приобретает товары
  - Простота пользовательского интерфейса и удобство работы
  - Отсутсвие ошибок при навигации по каталогу и приобретении контента
  - Скорость работы приложений
- **Administrator** - сотрудник сервиса, который обеспечивает обработку заказов и актуализацию каталога контента
  - Простота пользовательского интерфейса и удобство работы
  - Отсутсвие ошибок при администрировании конетнта
  - Скорость работы веб-приложения
  - Минимальное количество проблемных обращений от клиентов
- **Content producer** - сотрудник сервиса, который отвечает за создание и актуализацию качественного контента
  - Удобный пользовательский интерфейс для добавления конетента
- **Product owner** - сотрудник сервиса, который формирует скоуп разработки, отслеживает основные метрики сервиса и определяет приоритеты
  - Наличие интрументов мониторинга бизнесовых метрик
  - Стабильность работы сервиса
  - Возможность выдерживания пиковых нагрузок (например, в случае активации распродаж)
  - Возможность масштабирования решения (плановое увеличение нагрузки, количества пользователей, объема хранимой информации)
- **Developer** - сотрудник компании, который разработывает функционал сервиса
  - Современный стэк
  - Простота разработки и деплоя фич
  - Простота отладки
- **DevSecOps** - сотрудник компании, который обеспечивает безотказную и безопасную работу сервиса
  - Понятные средства мониторинга логов, технических метрик
  - Наличие механизмов оперативного уведомления и сбоях и других проблемах
  - Простые механизмы автоматического тестирования и деплоя новых фич

### User requirements

Здесь описаны основные пользовательсткие сценарии, которые удалось выявить в ходе исследования:

- Создание контента и наполнение им каталога
  - Content producer заходит в Product Management Backoffice
  - Content producer загружает новый контент в виде ZIP архива и добавляет сопровождающую мета-информацию (наименование контента, дата публикации, автор и т.д.)
- Приобретение клиентом контента
  - Customer заходит в Google Play или Apple App Store и скачивает наше мобильное приложение
  - Customer устанавливает приложение на устройство
  - Customer регистрируется в приложении используя SSO (учетная запись Google ID, либо Apple ID), либо вручную.
  - Customer используя функции поиска или навигацию по каталогу контента находит требуемый “товар”.
  - Customer открывает карточку товара.
  - Customer нажимает кнопку “Купить”.Откроется помощник для осуществления покупки:
  - Customer заполняет форму ввода персональных данных (ФИО, e-mail, страна, город, etc)
  - Customer заполняет форму ввода платежных реквизитов (Visa, Mastercard, Paypal, etc)
  - Customer подтверждает введенные данные и нажимает кнопку “Оплатить”
  - Customer на на указанный им e-mail получает квитанцию об оплате контента.
  - После обработки транзакции, Customer-у становится доступен приобретенный контент в разделе “Мои покупки” на определенный период времени.
  - После истечения периода времени приобретенный контент становится недоступен для просмотра.
- Адмитристрирование контента:
  - Administrator заходит в Product Management Backoffice
  - Administrator может добавить новый контент
  - Administrator может изменить мета-информацию существующего контента
  - Administrator может удалить существующий контент из каталога

### Контекстная схема

Ниже представлена упрощенная схема решения на уровне бизнес-контекста. Все пользователи взаимодействуют только с сервисами Google или Apple, а также используют почтовый сервис. Наш сервис интегрован с API Google и API Apple для деплоя приложений, реализации inApp платежей и других функций.
![Context diagram!](images/context.png 'Context diagram')

### Контейнерная схема

### Инфраструктурная схема

### Ключевые атрибуты качества

Поскольку проектируемая архитектура должна опираться на определенные бизнес-требования, ограничения и допущения ниже описаны основные атрибуты качества.

### Риски

### Безопасность

Для того, чтобы минимизировать риски утечек чувствительной информации о пользователях, их платежных данных и совершенных покупках, а также защитить систему от различных сбоев в ходе аттак на сервис, ниже предложен ряд мер.

#### Аутентификация и авторизация

Для реализации функций безопасной аутентификации и авторизации пользователей (компонент Authentication Service) Amazon предлагает AWS Cognito. Этот сервис можно будет использовать как для авторизации клиентов, так и внутренних пользователей с использованием OpenID Connect, OAuth 2.0 или SAML 2.0. Также он позволяет защитить пользовательские данные от взлома в ходе хаккерских атак.

#### Криптография

Наши данные должны быть покрыты шифрованием с использованием 256-bit Secure Socket Layer (SSL) как при использовании мобильных клиентских приложений, так и веб-приложений во внутреннем контуре.

#### Self-testing

Необходимо обеспечить регулярный прогон тестов: сканирование портов, тестирование на предмет SQL injection. Для хаотичного тестирования можно использовать наработки Netflix (https://github.com/Netflix/SimianArmy)

#### Приватные подсети

Необходимо использовать приватные подсети для защиты от прямого доступа к данным и сервисам из сети Интернет.

#### Технический аудит

Необходимо регулярно проводить внешний аудит системы для того, чтобы иметь независимую оценку о защищенности системы и хранимых данных.

### Элементы архитектуры

- **Mobile Application iOS** - мобильное приложение на платформе Apple iOS, доступное для скачивания в Apple Store
- **Mobile Application Android** - мобильное приложение на платформе Android, доступное для скачивания в Google Play
- **Google Play API** - API для взаимодействия с сервисами Google Play. В том числе Google Pay API.
- **Apple Store API** - API для взаимодействия с сервисами Apple Store. В том числе Apple Pay.
- **CDN** - сервис распределенной доставки и дистрибуции контента
- **API Gateway** - шлюз обеспечивающий взаимодействие между клиентскими приложениями и нашими сервисами (API)
- **Authentication Service** - сервис безопасной аутентификации пользователей
- **Product API Application** - программный интерфейс приложения обеспечивающего работу с каталогом контента
- **Product Management Backoffice** - веб-интерфейс обеспечивающие работу с каталогом контента, добапление нового контента и актуализацию уже загруженного
- **S3 Storage for static content** - объектное хранилище для статического контента
- **Products Database** - БД для хранении информации о продуктах
- **Orders Database** - БД для хранения информации о заказах
- **Cache** - промежуточное in-memory хранилище данных о продуктах
- **Orders web application** - веб-приложение для обработки заказов клиентов
- **Orders API Application** - программный интерфейс приложения обеспечивающего работу с заказами
- **Message Broker** - брокер сообщений обеспечивающий асинхронную обработку различных событий (например, отправка Push уведомлений клиентам, или квитанций об оплате)
- **S3 Storage for reports and logs** - долговременное хранилище исторических данных
- **GitLab** - здесь можно будет хранить артефакты разработки, реализовать репозиторий код, реализовать пайплайны CI/CD
- **Log and tracing** - ElasticSearch для поиска информации, LogStash для сбора, обработки логов, Kibana для визуализации

### Компоненты архитектуры в приземлении на AWS и OpenSource

### Architecture Decision Records (ADRs)

### Глоссарий

-
